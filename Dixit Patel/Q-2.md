## 2. How do you handle complex queries with sub-selects or CTEs (Common Table Expressions) in Laravelâ€™s query builder?

Answer :

Sub-selects allow you to include a query inside another query, often in the SELECT or WHERE clause.

Example 1: Sub-select in SELECT

Suppose you want to get users along with the number of posts each user has:
$users = DB::table('users')
    ->select('users.id', 'users.name')
    ->selectSub(function($query) {
        $query->from('posts')
              ->selectRaw('COUNT(*)')
              ->whereColumn('posts.user_id', 'users.id');
    }, 'posts_count')
    ->get();

$query->from('posts')->selectRaw('COUNT(*)')->whereColumn('posts.user_id', 'users.id') is the subquery.

The result gives a posts_count column for each user.

Example 2: Sub-select in WHERE

Find users who have more than 5 posts:

$users = DB::table('users')
    ->where(function($query) {
        $query->from('posts')
              ->selectRaw('COUNT(*)')
              ->whereColumn('posts.user_id', 'users.id')
              ->havingRaw('COUNT(*) > 5');
    })
    ->get();

--------------

Common Table Expressions (CTEs)

CTEs allow you to define a temporary result set that can be referenced within the main query. Useful for complex recursive queries or breaking down complicated logic.

Laravel supports CTEs via withExpression or withRecursiveExpression

Example 1: Simple CTE

Get users who joined in the last month:

$users = DB::table('users')
    ->withExpression('recent_users', function ($query) {
        $query->select('id', 'name')
              ->from('users')
              ->where('created_at', '>=', now()->subMonth());
    })
    ->from('recent_users')
    ->get();


withExpression('recent_users', ...) defines the CTE.

The main query selects from recent_users temporary table.